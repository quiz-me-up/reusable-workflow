name: Supprimer tous les packages Maven de l'organisation

on:
  workflow_dispatch:
    inputs:
      confirm_deletion:
        description: 'Tapez "CONFIRM" pour confirmer la suppression'
        required: true
        type: string
      dry_run:
        description: 'Mode dry-run (simulation sans suppression)'
        required: false
        type: boolean
        default: true

jobs:
  list-packages:
    runs-on: ubuntu-latest
    outputs:
      packages: ${{ steps.get-packages.outputs.packages }}
    steps:
      - name: VÃ©rifier la confirmation
        if: github.event.inputs.confirm_deletion != 'CONFIRM' && github.event.inputs.dry_run == 'false'
        run: |
          echo "âŒ Suppression annulÃ©e - confirmation requise"
          exit 1

      - name: Lister les packages Maven
        id: get-packages
        run: |
          echo "ğŸ” RÃ©cupÃ©ration des packages Maven..."
          
          # RÃ©cupÃ©rer tous les packages de type Maven de l'organisation
          packages=$(curl -s \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/orgs/${{ github.repository_owner }}/packages?package_type=maven&per_page=100" \
            | jq -r '.[].name')
          
          # Convertir en JSON array pour la matrice
          packages_json=$(echo "$packages" | jq -R -s -c 'split("\n") | map(select(length > 0))')
          
          echo "packages=$packages_json" >> $GITHUB_OUTPUT
          
          echo "ğŸ“¦ Packages Maven trouvÃ©s:"
          echo "$packages" | while read -r package; do
            if [ -n "$package" ]; then
              echo "  - $package"
            fi
          done

  delete-packages:
    needs: list-packages
    runs-on: ubuntu-latest
    if: needs.list-packages.outputs.packages != '[]'
    strategy:
      matrix:
        package: ${{ fromJson(needs.list-packages.outputs.packages) }}
      fail-fast: false
    steps:
      - name: Supprimer le package Maven
        uses: actions/delete-package-versions@v5
        with:
          package-name: ${{ matrix.package }}
          package-type: 'maven'
          token: ${{ secrets.GITHUB_TOKEN }}
          dry-run: ${{ github.event.inputs.dry_run }}
          min-versions-to-keep: 0
          delete-only-untagged-versions: false
          ignore-versions: ''

      - name: RÃ©sultat de la suppression
        run: |
          if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
            echo "ğŸ” [DRY RUN] Package ${{ matrix.package }} - simulation terminÃ©e"
          else
            echo "âœ… Package ${{ matrix.package }} supprimÃ© avec succÃ¨s"
          fi

  cleanup-summary:
    needs: [list-packages, delete-packages]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: RÃ©sumÃ© de l'opÃ©ration
        run: |
          echo "## ğŸ“‹ RÃ©sumÃ© de la suppression des packages Maven"
          echo ""
          
          if [ "${{ needs.list-packages.outputs.packages }}" == "[]" ]; then
            echo "â„¹ï¸  Aucun package Maven trouvÃ© dans l'organisation"
          else
            package_count=$(echo '${{ needs.list-packages.outputs.packages }}' | jq length)
            echo "ğŸ“¦ Packages traitÃ©s: $package_count"
          
            if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
              echo "ğŸ” Mode: Simulation (dry-run)"
              echo "âš ï¸  Aucune suppression rÃ©elle n'a Ã©tÃ© effectuÃ©e"
            else
              echo "ğŸ—‘ï¸  Mode: Suppression rÃ©elle"
              if [ "${{ needs.delete-packages.result }}" == "success" ]; then
                echo "âœ… Tous les packages ont Ã©tÃ© supprimÃ©s avec succÃ¨s"
              else
                echo "âŒ Certains packages n'ont pas pu Ãªtre supprimÃ©s"
              fi
            fi
          fi
          
          echo ""
          echo "### ğŸ”§ Pour relancer:"
          echo "- En mode simulation: Laissez 'dry_run' cochÃ©"
          echo "- En mode rÃ©el: DÃ©cochez 'dry_run' et tapez 'CONFIRM'"

# Permissions requises
permissions:
  packages: write
  contents: read
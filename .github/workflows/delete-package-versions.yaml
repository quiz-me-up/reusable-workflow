name: Delete all Maven packages from organization

on:
  workflow_dispatch:
    inputs:
      confirm_deletion:
        description: 'Type "CONFIRM" to confirm deletion'
        required: true
        type: string
      repository_name:
        description: 'Repository name (optional - if empty, deletes all org packages)'
        required: false
        type: string

jobs:
  list-packages:
    runs-on: ubuntu-latest
    outputs:
      packages: ${{ steps.get-packages.outputs.packages }}
    steps:
      - name: Verify confirmation
        if: github.event.inputs.confirm_deletion != 'CONFIRM'
        run: |
          echo "âŒ Deletion cancelled - confirmation required"
          exit 1

      - name: List Maven packages
        id: get-packages
        run: |
          if [ -n "${{ github.event.inputs.repository_name }}" ]; then
            echo "ğŸ” Fetching Maven packages for repository: ${{ github.event.inputs.repository_name }}"
          
            # Get packages from specific repository
            packages=$(curl -s \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${{ github.repository_owner }}/${{ github.event.inputs.repository_name }}/packages?package_type=maven&per_page=100" \
              | jq -r '.[].name')
          else
            echo "ğŸ” Fetching all Maven packages from organization..."
          
            # Get all Maven packages from the organization
            packages=$(curl -s \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/orgs/${{ github.repository_owner }}/packages?package_type=maven&per_page=100" \
              | jq -r '.[].name')
          fi
          
          # Convert to JSON array for matrix
          packages_json=$(echo "$packages" | jq -R -s -c 'split("\n") | map(select(length > 0))')
          
          echo "packages=$packages_json" >> $GITHUB_OUTPUT
          
          echo "ğŸ“¦ Maven packages found:"
          echo "$packages" | while read -r package; do
            if [ -n "$package" ]; then
              echo "  - $package"
            fi
          done

  delete-packages:
    needs: list-packages
    runs-on: ubuntu-latest
    if: needs.list-packages.outputs.packages != '[]'
    strategy:
      matrix:
        package: ${{ fromJson(needs.list-packages.outputs.packages) }}
      fail-fast: false
    steps:
      - name: Delete Maven package
        uses: actions/delete-package-versions@v5
        with:
          package-name: ${{ matrix.package }}
          package-type: 'maven'
          owner: ${{ github.repository_owner }}
          token: ${{ secrets.GITHUB_TOKEN }}
          min-versions-to-keep: 0
          delete-only-untagged-versions: false

      - name: Deletion result
        run: |
          echo "âœ… Package ${{ matrix.package }} deleted successfully"

  cleanup-summary:
    needs: [list-packages, delete-packages]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Operation summary
        run: |
          echo "## ğŸ“‹ Maven packages deletion summary"
          echo ""
          
          if [ -n "${{ github.event.inputs.repository_name }}" ]; then
            echo "ğŸ¯ Target: Repository '${{ github.event.inputs.repository_name }}'"
          else
            echo "ğŸ¯ Target: All organization packages"
          fi
          
          if [ "${{ needs.list-packages.outputs.packages }}" == "[]" ]; then
            echo "â„¹ï¸  No Maven packages found"
          else
            package_count=$(echo '${{ needs.list-packages.outputs.packages }}' | jq length)
            echo "ğŸ“¦ Packages processed: $package_count"
          
            if [ "${{ needs.delete-packages.result }}" == "success" ]; then
              echo "âœ… All packages deleted successfully"
            else
              echo "âŒ Some packages could not be deleted"
            fi
          fi

# Required permissions
permissions:
  packages: write
  contents: read
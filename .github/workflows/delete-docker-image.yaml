name: Delete all Docker Hub images from organization

on:
  workflow_dispatch:
    inputs:
      confirm_deletion:
        description: 'Type "CONFIRM" to confirm deletion'
        required: true
        type: string
      repository_name:
        description: 'Repository name (optional - if empty, deletes all org repositories)'
        required: false
        type: string

permissions:
  contents: read

env:
  DOCKERHUB_TOKEN: ${{ secrets.QUIZ_ME_UP_DOCKER_TOKEN }}
  DOCKERHUB_USERNAME: ${{ secrets.QUIZ_ME_UP_DOCKER_USERNAME }}
  DOCKERHUB_NAMESPACE: ${{ secrets.QUIZ_ME_UP_DOCKER_NAMESPACE }}

jobs:
  list-repositories:
    runs-on: ubuntu-latest
    outputs:
      repositories: ${{ steps.get-repositories.outputs.repositories }}
      has_repositories: ${{ steps.get-repositories.outputs.has_repositories }}
    steps:
      - name: Verify confirmation
        if: github.event.inputs.confirm_deletion != 'CONFIRM'
        run: |
          echo "âŒ Deletion cancelled - confirmation required"
          exit 1

      - name: Authenticate with Docker Hub
        id: docker-auth
        run: |
          echo "ğŸ” Authenticating with Docker Hub..."
          
          response=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -d "{\"username\": \"$DOCKERHUB_USERNAME\", \"password\": \"$DOCKERHUB_TOKEN\"}" \
            "https://hub.docker.com/v2/users/login/")
          
          auth_token=$(echo "$response" | jq -r '.token // empty')
          
          if [ -z "$auth_token" ] || [ "$auth_token" == "null" ]; then
            echo "âŒ Failed to authenticate with Docker Hub"
            echo "Response: $response"
            exit 1
          fi
          
          echo "âœ… Successfully authenticated with Docker Hub"
          echo "auth_token=$auth_token" >> $GITHUB_OUTPUT

      - name: List Docker Hub repositories
        id: get-repositories
        run: |
          if [ -n "${{ github.event.inputs.repository_name }}" ]; then
            echo "ğŸ” Processing specific repository: ${{ github.event.inputs.repository_name }}"
            repositories="[\"${{ github.event.inputs.repository_name }}\"]"
            has_repos="true"
          else
            echo "ğŸ” Fetching all repositories from Docker Hub namespace: $DOCKERHUB_NAMESPACE"
          
            # Initialize variables
            all_repos=""
            page=1
            has_repos="false"
            max_retries=3
          
            while true; do
              echo "ğŸ“„ Fetching page $page..."
              retry_count=0
          
              while [ $retry_count -lt $max_retries ]; do
                repositories_response=$(curl -s -w "HTTPSTATUS:%{http_code}" \
                  -H "Authorization: JWT ${{ steps.docker-auth.outputs.auth_token }}" \
                  -H "Accept: application/json" \
                  --max-time 30 \
                  "https://hub.docker.com/v2/repositories/$DOCKERHUB_NAMESPACE/?page=$page&page_size=100")
          
                # Extract HTTP status and body
                http_code=$(echo "$repositories_response" | grep -o "HTTPSTATUS:[0-9]*" | cut -d: -f2)
                response_body=$(echo "$repositories_response" | sed 's/HTTPSTATUS:[0-9]*$//')
          
                case $http_code in
                  200)
                    echo "âœ… Successfully fetched page $page"
                    break
                    ;;
                  401)
                    echo "âŒ Authentication failed (401) - check token validity"
                    echo "Response: $response_body"
                    exit 1
                    ;;
                  403)
                    echo "âŒ Permission denied (403) - check namespace access"
                    echo "Response: $response_body"
                    exit 1
                    ;;
                  404)
                    echo "â„¹ï¸ Namespace not found or no repositories (404): $DOCKERHUB_NAMESPACE"
                    # This might be legitimate - namespace exists but has no repos
                    response_body='{"results": []}'
                    break
                    ;;
                  429)
                    echo "â±ï¸ Rate limited (429) - waiting 30 seconds..."
                    sleep 30
                    retry_count=$((retry_count + 1))
                    continue
                    ;;
                  500|502|503|504)
                    echo "âš ï¸ Server error ($http_code) - retry $((retry_count + 1))/$max_retries"
                    retry_count=$((retry_count + 1))
                    if [ $retry_count -lt $max_retries ]; then
                      sleep $((retry_count * 5))
                      continue
                    else
                      echo "âŒ Max retries exceeded for server error"
                      exit 1
                    fi
                    ;;
                  "")
                    echo "âš ï¸ Empty response - retry $((retry_count + 1))/$max_retries"
                    retry_count=$((retry_count + 1))
                    if [ $retry_count -lt $max_retries ]; then
                      sleep $((retry_count * 2))
                      continue
                    else
                      echo "âŒ Max retries exceeded for empty response"
                      exit 1
                    fi
                    ;;
                  *)
                    echo "âŒ Unexpected HTTP status: $http_code"
                    echo "Response: $response_body"
                    exit 1
                    ;;
                esac
          
                break
              done
          
              # Validate JSON response
              if ! echo "$response_body" | jq empty 2>/dev/null; then
                echo "âŒ Invalid JSON response from Docker Hub API"
                echo "Response: $response_body"
                # Try to continue with empty results if this is the first page
                if [ $page -eq 1 ]; then
                  echo "ğŸ”„ Continuing with empty results for first page"
                  response_body='{"results": []}'
                else
                  echo "âŒ Stopping due to invalid JSON on page $page"
                  break
                fi
              fi
          
              # Extract repository names from this page (handle empty results gracefully)
              page_repos=$(echo "$response_body" | jq -r '.results[]?.name // empty' 2>/dev/null | grep -v '^$' || echo "")
          
              if [ -n "$page_repos" ]; then
                echo "ğŸ“¦ Found repositories on page $page:"
                echo "$page_repos" | while IFS= read -r repo; do
                  [ -n "$repo" ] && echo "  - $repo"
                done
          
                if [ -n "$all_repos" ]; then
                  all_repos="$all_repos"$'\n'"$page_repos"
                else
                  all_repos="$page_repos"
                fi
                has_repos="true"
              else
                echo "â„¹ï¸ No repositories found on page $page"
              fi
          
              # Check for next page
              next_page=$(echo "$response_body" | jq -r '.next // empty')
              if [ -z "$next_page" ] || [ "$next_page" == "null" ]; then
                echo "âœ… No more pages to fetch"
                break
              fi
          
              page=$((page + 1))
          
              # Safety limit to prevent infinite loops
              if [ $page -gt 1000 ]; then
                echo "âš ï¸ Reached page limit (1000) - stopping"
                break
              fi
            done
          
            # Convert to JSON array (handle empty case gracefully)
            if [ "$has_repos" == "true" ] && [ -n "$all_repos" ]; then
              repositories=$(echo "$all_repos" | jq -R -s 'split("\n") | map(select(length > 0))' 2>/dev/null || echo "[]")
              # Double-check the result is valid
              if ! echo "$repositories" | jq empty 2>/dev/null || [ "$(echo "$repositories" | jq length 2>/dev/null || echo "0")" -eq 0 ]; then
                repositories="[]"
                has_repos="false"
              fi
            else
              repositories="[]"
              has_repos="false"
            fi
          fi
          
          # Validate final JSON (ensure no parsing errors cause failure)
          if ! echo "$repositories" | jq empty 2>/dev/null; then
            echo "âš ï¸ JSON parsing issue detected - defaulting to empty array"
            repositories="[]"
            has_repos="false"
          fi
          
          # Set outputs
          echo "repositories<<EOF" >> $GITHUB_OUTPUT
          echo "$repositories" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "has_repositories=$has_repos" >> $GITHUB_OUTPUT
          
          # Display results
          repo_count=$(echo "$repositories" | jq length 2>/dev/null || echo "0")
          
          if [ "$repo_count" -eq 0 ]; then
            echo "â„¹ï¸ No Docker repositories found in namespace: $DOCKERHUB_NAMESPACE"
            echo "âœ… This is not an error - the namespace is clean or empty"
          else
            echo "ğŸ³ Found $repo_count Docker repositories to process:"
            echo "$repositories" | jq -r '.[]' 2>/dev/null | while IFS= read -r repo; do
              [ -n "$repo" ] && echo " - $DOCKERHUB_NAMESPACE/$repo"
            done
          fi

  delete-repositories:
    needs: list-repositories
    runs-on: ubuntu-latest
    if: needs.list-repositories.outputs.has_repositories == 'true'
    strategy:
      matrix:
        repository: ${{ fromJson(needs.list-repositories.outputs.repositories) }}
      fail-fast: false
      max-parallel: 5
    steps:
      - name: Re-authenticate with Docker Hub
        id: fresh-auth
        run: |
          echo "ğŸ” Re-authenticating with Docker Hub for fresh token..."
          
          max_retries=3
          retry_count=0
          
          while [ $retry_count -lt $max_retries ]; do
            response=$(curl -s -X POST \
              -H "Content-Type: application/json" \
              --max-time 30 \
              -d "{\"username\": \"$DOCKERHUB_USERNAME\", \"password\": \"$DOCKERHUB_TOKEN\"}" \
              "https://hub.docker.com/v2/users/login/")
          
            auth_token=$(echo "$response" | jq -r '.token // empty')
          
            if [ -n "$auth_token" ] && [ "$auth_token" != "null" ]; then
              echo "âœ… Successfully re-authenticated with Docker Hub"
              echo "auth_token=$auth_token" >> $GITHUB_OUTPUT
              break
            else
              retry_count=$((retry_count + 1))
              echo "âš ï¸ Authentication attempt $retry_count failed"
              if [ $retry_count -lt $max_retries ]; then
                sleep $((retry_count * 2))
              else
                echo "âŒ Failed to re-authenticate after $max_retries attempts"
                echo "Response: $response"
                exit 1
              fi
            fi
          done

      - name: Delete Docker Hub repository
        run: |
          echo "ğŸ—‘ï¸ Processing repository: $DOCKERHUB_NAMESPACE/${{ matrix.repository }}"
          
          AUTH_TOKEN="${{ steps.fresh-auth.outputs.auth_token }}"
          max_retries=3
          
          # Verify repository exists
          retry_count=0
          while [ $retry_count -lt $max_retries ]; do
            repo_info=$(curl -s -w "HTTPSTATUS:%{http_code}" \
              -H "Authorization: JWT $AUTH_TOKEN" \
              -H "Accept: application/json" \
              --max-time 30 \
              "https://hub.docker.com/v2/repositories/$DOCKERHUB_NAMESPACE/${{ matrix.repository }}/")
          
            http_code=$(echo "$repo_info" | grep -o "HTTPSTATUS:[0-9]*" | cut -d: -f2)
            response_body=$(echo "$repo_info" | sed 's/HTTPSTATUS:[0-9]*$//')
          
            if [ "$http_code" == "200" ]; then
              break
            elif [ "$http_code" == "429" ]; then
              echo "â±ï¸ Rate limited - waiting before retry..."
              sleep 30
              retry_count=$((retry_count + 1))
            elif [[ "$http_code" =~ ^(500|502|503|504)$ ]]; then
              retry_count=$((retry_count + 1))
              if [ $retry_count -lt $max_retries ]; then
                echo "âš ï¸ Server error ($http_code) - retrying in $((retry_count * 5)) seconds..."
                sleep $((retry_count * 5))
              fi
            else
              break
            fi
          done
          
          if [ "$http_code" == "200" ] && echo "$response_body" | jq -e '.name' > /dev/null 2>&1; then
            echo "âœ… Repository found: $DOCKERHUB_NAMESPACE/${{ matrix.repository }}"
          
            # Get repository statistics
            tags_response=$(curl -s \
              -H "Authorization: JWT $AUTH_TOKEN" \
              -H "Accept: application/json" \
              --max-time 30 \
              "https://hub.docker.com/v2/repositories/$DOCKERHUB_NAMESPACE/${{ matrix.repository }}/tags/?page_size=1")
          
            tags_count=$(echo "$tags_response" | jq -r '.count // 0')
            echo "ğŸ“Š Repository contains $tags_count tag(s)"
          
            # Delete repository with retries
            echo "ğŸ—‘ï¸ Deleting repository $DOCKERHUB_NAMESPACE/${{ matrix.repository }}..."
          
            retry_count=0
            while [ $retry_count -lt $max_retries ]; do
              delete_response=$(curl -s -w "HTTPSTATUS:%{http_code}" -X DELETE \
                -H "Authorization: JWT $AUTH_TOKEN" \
                -H "Accept: application/json" \
                --max-time 60 \
                "https://hub.docker.com/v2/repositories/$DOCKERHUB_NAMESPACE/${{ matrix.repository }}/")
          
              delete_http_code=$(echo "$delete_response" | grep -o "HTTPSTATUS:[0-9]*" | cut -d: -f2)
              delete_response_body=$(echo "$delete_response" | sed 's/HTTPSTATUS:[0-9]*$//')
          
              case $delete_http_code in
                202)
                  echo "âœ… Repository $DOCKERHUB_NAMESPACE/${{ matrix.repository }} deletion accepted (processing asynchronously)"
                  break
                  ;;
                204)
                  echo "âœ… Repository $DOCKERHUB_NAMESPACE/${{ matrix.repository }} deleted successfully"
                  break
                  ;;
                401)
                  echo "âŒ Authentication failed for repository $DOCKERHUB_NAMESPACE/${{ matrix.repository }}"
                  echo "Token may have expired or insufficient permissions"
                  echo "Response: $delete_response_body"
                  exit 1
                  ;;
                403)
                  echo "âŒ Permission denied for repository $DOCKERHUB_NAMESPACE/${{ matrix.repository }}"
                  echo "Check namespace permissions and token scopes"
                  echo "Response: $delete_response_body"
                  exit 1
                  ;;
                404)
                  echo "â„¹ï¸ Repository $DOCKERHUB_NAMESPACE/${{ matrix.repository }} not found or already deleted"
                  break
                  ;;
                429)
                  echo "â±ï¸ Rate limited during deletion - waiting before retry..."
                  sleep 30
                  retry_count=$((retry_count + 1))
                  ;;
                500|502|503|504)
                  retry_count=$((retry_count + 1))
                  if [ $retry_count -lt $max_retries ]; then
                    echo "âš ï¸ Server error ($delete_http_code) during deletion - retrying in $((retry_count * 5)) seconds..."
                    sleep $((retry_count * 5))
                  else
                    echo "âŒ Max retries exceeded for server error during deletion"
                    exit 1
                  fi
                  ;;
                *)
                  echo "âŒ Unexpected error for repository $DOCKERHUB_NAMESPACE/${{ matrix.repository }} (HTTP $delete_http_code)"
                  echo "Response: $delete_response_body"
                  exit 1
                  ;;
              esac
            done
          else
            case $http_code in
              404)
                echo "â„¹ï¸ Repository $DOCKERHUB_NAMESPACE/${{ matrix.repository }} not found"
                ;;
              401|403)
                echo "âŒ Access denied to repository $DOCKERHUB_NAMESPACE/${{ matrix.repository }} (HTTP $http_code)"
                echo "Response: $response_body"
                exit 1
                ;;
              *)
                echo "âŒ Error checking repository $DOCKERHUB_NAMESPACE/${{ matrix.repository }} (HTTP $http_code)"
                echo "Response: $response_body"
                exit 1
                ;;
            esac
          fi

      - name: Repository deletion result
        run: |
          echo "ğŸ“‹ Processing completed for repository: $DOCKERHUB_NAMESPACE/${{ matrix.repository }}"

  cleanup-summary:
    needs: [list-repositories, delete-repositories]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Operation summary
        run: |
          echo "# ğŸ“‹ Docker Hub Repository Deletion Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "**ğŸ³ Docker Hub Namespace:** \`$DOCKERHUB_NAMESPACE\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -n "${{ github.event.inputs.repository_name }}" ]; then
            echo "**ğŸ¯ Target:** Repository \`${{ github.event.inputs.repository_name }}\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "**ğŸ¯ Target:** All namespace repositories" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "**âš™ï¸ Mode:** Delete all repositories and their images" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.list-repositories.outputs.has_repositories }}" != "true" ]; then
            echo "**âœ… Result:** No Docker repositories found in namespace" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The namespace \`$DOCKERHUB_NAMESPACE\` appears to be empty or does not contain any accessible repositories." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ‰ **This is successful!** Your namespace is already clean." >> $GITHUB_STEP_SUMMARY
          else
            repo_count=$(echo '${{ needs.list-repositories.outputs.repositories }}' | jq length 2>/dev/null || echo "0")
            echo "**ğŸ³ Repositories processed:** $repo_count" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          
            # List processed repositories
            echo "**ğŸ“¦ Repositories:**" >> $GITHUB_STEP_SUMMARY
            echo '${{ needs.list-repositories.outputs.repositories }}' | jq -r '.[]' | while read -r repo; do
              echo "- \`$DOCKERHUB_NAMESPACE/$repo\`" >> $GITHUB_STEP_SUMMARY
            done
            echo "" >> $GITHUB_STEP_SUMMARY
          
            if [ "${{ needs.delete-repositories.result }}" == "success" ]; then
              echo "**âœ… Status:** All repositories deleted successfully" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ needs.delete-repositories.result }}" == "failure" ]; then
              echo "**âŒ Status:** Some errors occurred during deletion" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ needs.delete-repositories.result }}" == "skipped" ]; then
              echo "**âš ï¸ Status:** Deletion job was skipped" >> $GITHUB_STEP_SUMMARY
            else
              echo "**âš ï¸ Status:** Process was cancelled or encountered an issue" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ğŸ• Completed at:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          
          # Console output
          if [ "${{ needs.list-repositories.outputs.has_repositories }}" != "true" ]; then
            echo "âœ… No repositories found in Docker Hub namespace: $DOCKERHUB_NAMESPACE"
            echo "ğŸ‰ Namespace is already clean - workflow completed successfully"
          else
            echo "âœ… Docker Hub cleanup workflow completed"
          fi
          echo "ğŸ“Š Check the summary tab for detailed results"